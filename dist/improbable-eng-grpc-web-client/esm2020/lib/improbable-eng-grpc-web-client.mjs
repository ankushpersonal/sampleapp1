import { Inject, Injectable, Optional } from '@angular/core';
import { grpc } from '@improbable-eng/grpc-web';
import { GrpcDataEvent, GrpcMetadata, GrpcStatusEvent } from '@ngx-grpc/common';
import { Observable } from 'rxjs';
import { IMPROBABLE_ENG_GRPC_WEB_CLIENT_DEFAULT_SETTINGS } from './tokens';
import * as i0 from "@angular/core";
/**
 * GrpcClientFactory implementation based on @improbable-eng/grpc-web
 */
export class ImprobableEngGrpcWebClientFactory {
    constructor(defaultSettings) {
        this.defaultSettings = defaultSettings;
    }
    createClient(serviceId, customSettings) {
        const settings = customSettings || this.defaultSettings;
        if (!settings) {
            throw new Error(`grpc-web client factory: no settings provided for ${serviceId}`);
        }
        return new ImprobableEngGrpcWebClient(serviceId, { ...settings });
    }
}
ImprobableEngGrpcWebClientFactory.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.3", ngImport: i0, type: ImprobableEngGrpcWebClientFactory, deps: [{ token: IMPROBABLE_ENG_GRPC_WEB_CLIENT_DEFAULT_SETTINGS, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
ImprobableEngGrpcWebClientFactory.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.2.3", ngImport: i0, type: ImprobableEngGrpcWebClientFactory });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.3", ngImport: i0, type: ImprobableEngGrpcWebClientFactory, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [IMPROBABLE_ENG_GRPC_WEB_CLIENT_DEFAULT_SETTINGS]
                }] }]; } });
/**
 * GrpcClient implementation based on grpc-web
 */
export class ImprobableEngGrpcWebClient {
    constructor(serviceId, settings) {
        this.serviceId = serviceId;
        this.settings = settings;
        // implementation is based on https://github.com/improbable-eng/grpc-web/blob/master/client/grpc-web-react-example/ts/_proto/examplecom/library/book_service_pb_service.js
        this.client = (() => {
            function Client() { }
            Client.serviceName = this.serviceId;
            return Client;
        })();
    }
    getSettings() {
        return { ...this.settings };
    }
    unary(path, request, metadata, reqclss, resclss) {
        return new Observable(obs => {
            const methodName = path.split('/')[2];
            const methodDescriptor = {
                methodName,
                service: this.client,
                requestStream: false,
                responseStream: false,
                requestType: reqclss,
                responseType: resclss,
            };
            const client = grpc.unary(methodDescriptor, {
                request,
                host: this.settings.host,
                metadata: new grpc.Metadata(metadata?.toObject() ?? {}),
                transport: this.getTransport('unary'),
                debug: this.settings.debug,
                onEnd: (response) => {
                    obs.next(new GrpcStatusEvent(response.status, response.statusMessage, this.castResponseMetadata(response.trailers)));
                    if (response.status !== grpc.Code.OK) {
                        obs.complete();
                    }
                    else {
                        obs.next(new GrpcDataEvent(response.message));
                        obs.complete();
                    }
                },
            });
            return () => client.close();
        });
    }
    serverStream(path, request, metadata, reqclss, resclss) {
        const methodName = path.split('/')[2];
        const methodDescriptor = {
            methodName,
            service: this.client,
            requestStream: false,
            responseStream: true,
            requestType: reqclss,
            responseType: resclss,
        };
        return new Observable(obs => {
            const client = grpc.invoke(methodDescriptor, {
                request,
                host: this.settings.host,
                metadata: new grpc.Metadata(metadata?.toObject() ?? {}),
                transport: this.getTransport('serverStream'),
                debug: this.settings.debug,
                onMessage: (data) => {
                    obs.next(new GrpcDataEvent(data));
                },
                onEnd: (status, statusMessage, trailers) => {
                    obs.next(new GrpcStatusEvent(status, statusMessage, this.castResponseMetadata(trailers)));
                    obs.complete();
                },
            });
            return () => client.close();
        });
    }
    clientStream(path, inputStream, metadata, reqclss, resclss) {
        const methodName = path.split('/')[2];
        const methodDescriptor = {
            methodName,
            service: this.client,
            requestStream: true,
            responseStream: false,
            requestType: reqclss,
            responseType: resclss,
        };
        return new Observable(obs => {
            const client = grpc.client(methodDescriptor, {
                host: this.settings.host,
                transport: this.getTransport('clientStream'),
                debug: this.settings.debug,
            });
            client.start(new grpc.Metadata(metadata?.toObject() ?? {}));
            const inputStreamSub = inputStream.subscribe(message => {
                client.send(message);
            }, () => {
                client.close();
            }, () => {
                client.finishSend();
            });
            client.onMessage(data => obs.next(new GrpcDataEvent(data)));
            client.onEnd((status, statusMessage, trailers) => {
                obs.next(new GrpcStatusEvent(status, statusMessage, this.castResponseMetadata(trailers)));
                obs.complete();
            });
            return () => {
                inputStreamSub.unsubscribe();
                client.close();
            };
        });
    }
    bidiStream(path, inputStream, metadata, reqclss, resclss) {
        const methodName = path.split('/')[2];
        const methodDescriptor = {
            methodName,
            service: this.client,
            requestStream: true,
            responseStream: false,
            requestType: reqclss,
            responseType: resclss,
        };
        return new Observable(obs => {
            const client = grpc.client(methodDescriptor, {
                host: this.settings.host,
                transport: this.getTransport('bidiStream'),
                debug: this.settings.debug,
            });
            client.start(new grpc.Metadata(metadata?.toObject() ?? {}));
            const inputStreamSub = inputStream.subscribe(message => {
                client.send(message);
            }, () => {
                client.close();
            }, () => {
                client.finishSend();
            });
            client.onMessage(data => obs.next(new GrpcDataEvent(data)));
            client.onEnd((status, statusMessage, trailers) => {
                obs.next(new GrpcStatusEvent(status, statusMessage, this.castResponseMetadata(trailers)));
                obs.complete();
            });
            return () => {
                inputStreamSub.unsubscribe();
                client.close();
            };
        });
    }
    castResponseMetadata({ headersMap }) {
        return new GrpcMetadata(Object.keys(headersMap).reduce((r, k) => ({ ...r, [k]: headersMap[k][0] }), {}));
    }
    getTransport(key) {
        const { transport } = this.settings;
        return typeof transport === 'function' ? transport : transport[key];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wcm9iYWJsZS1lbmctZ3JwYy13ZWItY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGFja2FnZXMvaW1wcm9iYWJsZS1lbmctZ3JwYy13ZWItY2xpZW50L3NyYy9saWIvaW1wcm9iYWJsZS1lbmctZ3JwYy13ZWItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFHaEQsT0FBTyxFQUFpQyxhQUFhLEVBQTRDLFlBQVksRUFBRSxlQUFlLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN6SixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSwrQ0FBK0MsRUFBRSxNQUFNLFVBQVUsQ0FBQzs7QUFxQjNFOztHQUVHO0FBRUgsTUFBTSxPQUFPLGlDQUFpQztJQUU1QyxZQUMrRSxlQUFtRDtRQUFuRCxvQkFBZSxHQUFmLGVBQWUsQ0FBb0M7SUFDOUgsQ0FBQztJQUVMLFlBQVksQ0FBQyxTQUFpQixFQUFFLGNBQWtEO1FBQ2hGLE1BQU0sUUFBUSxHQUFHLGNBQWMsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDO1FBRXhELElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixNQUFNLElBQUksS0FBSyxDQUFDLHFEQUFxRCxTQUFTLEVBQUUsQ0FBQyxDQUFDO1NBQ25GO1FBRUQsT0FBTyxJQUFJLDBCQUEwQixDQUFDLFNBQVMsRUFBRSxFQUFFLEdBQUcsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUNwRSxDQUFDOzs4SEFkVSxpQ0FBaUMsa0JBR3RCLCtDQUErQztrSUFIMUQsaUNBQWlDOzJGQUFqQyxpQ0FBaUM7a0JBRDdDLFVBQVU7OzBCQUlOLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMsK0NBQStDOztB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QyxDQUFDO0lBQzNHLENBQUM7SUFFTyxZQUFZLENBQUMsR0FBK0M7UUFDbEUsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFFcEMsT0FBTyxPQUFPLFNBQVMsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGdycGMgfSBmcm9tICdAaW1wcm9iYWJsZS1lbmcvZ3JwYy13ZWInO1xuaW1wb3J0IHsgTWV0YWRhdGEgfSBmcm9tICdAaW1wcm9iYWJsZS1lbmcvZ3JwYy13ZWIvZGlzdC90eXBpbmdzL21ldGFkYXRhJztcbmltcG9ydCB7IFRyYW5zcG9ydEZhY3RvcnkgfSBmcm9tICdAaW1wcm9iYWJsZS1lbmcvZ3JwYy13ZWIvZGlzdC90eXBpbmdzL3RyYW5zcG9ydHMvVHJhbnNwb3J0JztcbmltcG9ydCB7IEdycGNDbGllbnQsIEdycGNDbGllbnRGYWN0b3J5LCBHcnBjRGF0YUV2ZW50LCBHcnBjRXZlbnQsIEdycGNNZXNzYWdlLCBHcnBjTWVzc2FnZUNsYXNzLCBHcnBjTWV0YWRhdGEsIEdycGNTdGF0dXNFdmVudCB9IGZyb20gJ0BuZ3gtZ3JwYy9jb21tb24nO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSU1QUk9CQUJMRV9FTkdfR1JQQ19XRUJfQ0xJRU5UX0RFRkFVTFRfU0VUVElOR1MgfSBmcm9tICcuL3Rva2Vucyc7XG5cbi8qKlxuICogU2V0dGluZ3MgZm9yIHRoZSBjaG9zZW4gaW1wbGVtZW50YXRpb24gb2YgR3JwY0NsaWVudFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEltcHJvYmFibGVFbmdHcnBjV2ViQ2xpZW50U2V0dGluZ3Mge1xuICBob3N0OiBzdHJpbmc7XG4gIHRyYW5zcG9ydDogVHJhbnNwb3J0RmFjdG9yeSB8IEltcHJvYmFibGVFbmdHcnBjV2ViQ2xpZW50VHJhbnNwb3J0cztcbiAgZGVidWc/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFNldHRpbmdzIGZvciB0aGUgdHJhbnNwb3J0IGltcGxlbWVudGF0aW9uIGZvciBlYWNoIHJlcXVlc3RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbXByb2JhYmxlRW5nR3JwY1dlYkNsaWVudFRyYW5zcG9ydHMge1xuICB1bmFyeTogVHJhbnNwb3J0RmFjdG9yeTtcbiAgc2VydmVyU3RyZWFtOiBUcmFuc3BvcnRGYWN0b3J5O1xuICBjbGllbnRTdHJlYW06IFRyYW5zcG9ydEZhY3Rvcnk7XG4gIGJpZGlTdHJlYW06IFRyYW5zcG9ydEZhY3Rvcnk7XG59XG5cbi8qKlxuICogR3JwY0NsaWVudEZhY3RvcnkgaW1wbGVtZW50YXRpb24gYmFzZWQgb24gQGltcHJvYmFibGUtZW5nL2dycGMtd2ViXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBJbXByb2JhYmxlRW5nR3JwY1dlYkNsaWVudEZhY3RvcnkgaW1wbGVtZW50cyBHcnBjQ2xpZW50RmFjdG9yeTxJbXByb2JhYmxlRW5nR3JwY1dlYkNsaWVudFNldHRpbmdzPiB7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChJTVBST0JBQkxFX0VOR19HUlBDX1dFQl9DTElFTlRfREVGQVVMVF9TRVRUSU5HUykgcHJpdmF0ZSBkZWZhdWx0U2V0dGluZ3M6IEltcHJvYmFibGVFbmdHcnBjV2ViQ2xpZW50U2V0dGluZ3MsXG4gICkgeyB9XG5cbiAgY3JlYXRlQ2xpZW50KHNlcnZpY2VJZDogc3RyaW5nLCBjdXN0b21TZXR0aW5nczogSW1wcm9iYWJsZUVuZ0dycGNXZWJDbGllbnRTZXR0aW5ncykge1xuICAgIGNvbnN0IHNldHRpbmdzID0gY3VzdG9tU2V0dGluZ3MgfHwgdGhpcy5kZWZhdWx0U2V0dGluZ3M7XG5cbiAgICBpZiAoIXNldHRpbmdzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGdycGMtd2ViIGNsaWVudCBmYWN0b3J5OiBubyBzZXR0aW5ncyBwcm92aWRlZCBmb3IgJHtzZXJ2aWNlSWR9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBJbXByb2JhYmxlRW5nR3JwY1dlYkNsaWVudChzZXJ2aWNlSWQsIHsgLi4uc2V0dGluZ3MgfSk7XG4gIH1cblxufVxuXG4vKipcbiAqIEdycGNDbGllbnQgaW1wbGVtZW50YXRpb24gYmFzZWQgb24gZ3JwYy13ZWJcbiAqL1xuZXhwb3J0IGNsYXNzIEltcHJvYmFibGVFbmdHcnBjV2ViQ2xpZW50IGltcGxlbWVudHMgR3JwY0NsaWVudDxJbXByb2JhYmxlRW5nR3JwY1dlYkNsaWVudFNldHRpbmdzPiB7XG5cbiAgcHJpdmF0ZSBjbGllbnQ6IGFueTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHNlcnZpY2VJZDogc3RyaW5nLFxuICAgIHByaXZhdGUgc2V0dGluZ3M6IEltcHJvYmFibGVFbmdHcnBjV2ViQ2xpZW50U2V0dGluZ3MsXG4gICkge1xuICAgIC8vIGltcGxlbWVudGF0aW9uIGlzIGJhc2VkIG9uIGh0dHBzOi8vZ2l0aHViLmNvbS9pbXByb2JhYmxlLWVuZy9ncnBjLXdlYi9ibG9iL21hc3Rlci9jbGllbnQvZ3JwYy13ZWItcmVhY3QtZXhhbXBsZS90cy9fcHJvdG8vZXhhbXBsZWNvbS9saWJyYXJ5L2Jvb2tfc2VydmljZV9wYl9zZXJ2aWNlLmpzXG4gICAgdGhpcy5jbGllbnQgPSAoKCkgPT4ge1xuICAgICAgZnVuY3Rpb24gQ2xpZW50KCkgeyB9XG4gICAgICBDbGllbnQuc2VydmljZU5hbWUgPSB0aGlzLnNlcnZpY2VJZDtcbiAgICAgIHJldHVybiBDbGllbnQ7XG4gICAgfSkoKTtcbiAgfVxuXG4gIGdldFNldHRpbmdzKCk6IEltcHJvYmFibGVFbmdHcnBjV2ViQ2xpZW50U2V0dGluZ3Mge1xuICAgIHJldHVybiB7IC4uLnRoaXMuc2V0dGluZ3MgfTtcbiAgfVxuXG4gIHVuYXJ5PFEgZXh0ZW5kcyBHcnBjTWVzc2FnZSwgUyBleHRlbmRzIEdycGNNZXNzYWdlPihcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgcmVxdWVzdDogUSxcbiAgICBtZXRhZGF0YTogR3JwY01ldGFkYXRhLFxuICAgIHJlcWNsc3M6IEdycGNNZXNzYWdlQ2xhc3M8UT4sXG4gICAgcmVzY2xzczogR3JwY01lc3NhZ2VDbGFzczxTPixcbiAgKTogT2JzZXJ2YWJsZTxHcnBjRXZlbnQ8Uz4+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzID0+IHtcbiAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBwYXRoLnNwbGl0KCcvJylbMl07XG5cbiAgICAgIGNvbnN0IG1ldGhvZERlc2NyaXB0b3IgPSB7XG4gICAgICAgIG1ldGhvZE5hbWUsXG4gICAgICAgIHNlcnZpY2U6IHRoaXMuY2xpZW50LFxuICAgICAgICByZXF1ZXN0U3RyZWFtOiBmYWxzZSxcbiAgICAgICAgcmVzcG9uc2VTdHJlYW06IGZhbHNlLFxuICAgICAgICByZXF1ZXN0VHlwZTogcmVxY2xzcyxcbiAgICAgICAgcmVzcG9uc2VUeXBlOiByZXNjbHNzLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgY2xpZW50ID0gZ3JwYy51bmFyeShtZXRob2REZXNjcmlwdG9yIGFzIGFueSwge1xuICAgICAgICByZXF1ZXN0LFxuICAgICAgICBob3N0OiB0aGlzLnNldHRpbmdzLmhvc3QsXG4gICAgICAgIG1ldGFkYXRhOiBuZXcgZ3JwYy5NZXRhZGF0YShtZXRhZGF0YT8udG9PYmplY3QoKSA/PyB7fSksXG4gICAgICAgIHRyYW5zcG9ydDogdGhpcy5nZXRUcmFuc3BvcnQoJ3VuYXJ5JyksXG4gICAgICAgIGRlYnVnOiB0aGlzLnNldHRpbmdzLmRlYnVnLFxuICAgICAgICBvbkVuZDogKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgb2JzLm5leHQobmV3IEdycGNTdGF0dXNFdmVudChyZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLnN0YXR1c01lc3NhZ2UsIHRoaXMuY2FzdFJlc3BvbnNlTWV0YWRhdGEocmVzcG9uc2UudHJhaWxlcnMpKSk7XG5cbiAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSBncnBjLkNvZGUuT0spIHtcbiAgICAgICAgICAgIG9icy5jb21wbGV0ZSgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvYnMubmV4dChuZXcgR3JwY0RhdGFFdmVudDxTPihyZXNwb25zZS5tZXNzYWdlIGFzIFMpKTtcbiAgICAgICAgICAgIG9icy5jb21wbGV0ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gKCkgPT4gY2xpZW50LmNsb3NlKCk7XG4gICAgfSk7XG5cbiAgfVxuXG4gIHNlcnZlclN0cmVhbTxRIGV4dGVuZHMgR3JwY01lc3NhZ2UsIFMgZXh0ZW5kcyBHcnBjTWVzc2FnZT4oXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIHJlcXVlc3Q6IFEsXG4gICAgbWV0YWRhdGE6IEdycGNNZXRhZGF0YSxcbiAgICByZXFjbHNzOiBHcnBjTWVzc2FnZUNsYXNzPFE+LFxuICAgIHJlc2Nsc3M6IEdycGNNZXNzYWdlQ2xhc3M8Uz4sXG4gICk6IE9ic2VydmFibGU8R3JwY0V2ZW50PFM+PiB7XG4gICAgY29uc3QgbWV0aG9kTmFtZSA9IHBhdGguc3BsaXQoJy8nKVsyXTtcblxuICAgIGNvbnN0IG1ldGhvZERlc2NyaXB0b3IgPSB7XG4gICAgICBtZXRob2ROYW1lLFxuICAgICAgc2VydmljZTogdGhpcy5jbGllbnQsXG4gICAgICByZXF1ZXN0U3RyZWFtOiBmYWxzZSxcbiAgICAgIHJlc3BvbnNlU3RyZWFtOiB0cnVlLFxuICAgICAgcmVxdWVzdFR5cGU6IHJlcWNsc3MsXG4gICAgICByZXNwb25zZVR5cGU6IHJlc2Nsc3MsXG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnMgPT4ge1xuICAgICAgY29uc3QgY2xpZW50ID0gZ3JwYy5pbnZva2UobWV0aG9kRGVzY3JpcHRvciwge1xuICAgICAgICByZXF1ZXN0LFxuICAgICAgICBob3N0OiB0aGlzLnNldHRpbmdzLmhvc3QsXG4gICAgICAgIG1ldGFkYXRhOiBuZXcgZ3JwYy5NZXRhZGF0YShtZXRhZGF0YT8udG9PYmplY3QoKSA/PyB7fSksXG4gICAgICAgIHRyYW5zcG9ydDogdGhpcy5nZXRUcmFuc3BvcnQoJ3NlcnZlclN0cmVhbScpLFxuICAgICAgICBkZWJ1ZzogdGhpcy5zZXR0aW5ncy5kZWJ1ZyxcbiAgICAgICAgb25NZXNzYWdlOiAoZGF0YSkgPT4ge1xuICAgICAgICAgIG9icy5uZXh0KG5ldyBHcnBjRGF0YUV2ZW50KGRhdGEgYXMgYW55KSk7XG4gICAgICAgIH0sXG4gICAgICAgIG9uRW5kOiAoc3RhdHVzLCBzdGF0dXNNZXNzYWdlLCB0cmFpbGVycykgPT4ge1xuICAgICAgICAgIG9icy5uZXh0KG5ldyBHcnBjU3RhdHVzRXZlbnQoc3RhdHVzLCBzdGF0dXNNZXNzYWdlLCB0aGlzLmNhc3RSZXNwb25zZU1ldGFkYXRhKHRyYWlsZXJzKSkpO1xuICAgICAgICAgIG9icy5jb21wbGV0ZSgpO1xuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiAoKSA9PiBjbGllbnQuY2xvc2UoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNsaWVudFN0cmVhbTxRIGV4dGVuZHMgR3JwY01lc3NhZ2UsIFMgZXh0ZW5kcyBHcnBjTWVzc2FnZT4oXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGlucHV0U3RyZWFtOiBPYnNlcnZhYmxlPFE+LFxuICAgIG1ldGFkYXRhOiBHcnBjTWV0YWRhdGEsXG4gICAgcmVxY2xzczogR3JwY01lc3NhZ2VDbGFzczxRPixcbiAgICByZXNjbHNzOiBHcnBjTWVzc2FnZUNsYXNzPFM+LFxuICApOiBPYnNlcnZhYmxlPEdycGNFdmVudDxTPj4ge1xuICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBwYXRoLnNwbGl0KCcvJylbMl07XG5cbiAgICBjb25zdCBtZXRob2REZXNjcmlwdG9yID0ge1xuICAgICAgbWV0aG9kTmFtZSxcbiAgICAgIHNlcnZpY2U6IHRoaXMuY2xpZW50LFxuICAgICAgcmVxdWVzdFN0cmVhbTogdHJ1ZSxcbiAgICAgIHJlc3BvbnNlU3RyZWFtOiBmYWxzZSxcbiAgICAgIHJlcXVlc3RUeXBlOiByZXFjbHNzLFxuICAgICAgcmVzcG9uc2VUeXBlOiByZXNjbHNzLFxuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzID0+IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGdycGMuY2xpZW50KG1ldGhvZERlc2NyaXB0b3IsIHtcbiAgICAgICAgaG9zdDogdGhpcy5zZXR0aW5ncy5ob3N0LFxuICAgICAgICB0cmFuc3BvcnQ6IHRoaXMuZ2V0VHJhbnNwb3J0KCdjbGllbnRTdHJlYW0nKSxcbiAgICAgICAgZGVidWc6IHRoaXMuc2V0dGluZ3MuZGVidWcsXG4gICAgICB9KTtcblxuICAgICAgY2xpZW50LnN0YXJ0KG5ldyBncnBjLk1ldGFkYXRhKG1ldGFkYXRhPy50b09iamVjdCgpID8/IHt9KSk7XG5cbiAgICAgIGNvbnN0IGlucHV0U3RyZWFtU3ViID0gaW5wdXRTdHJlYW0uc3Vic2NyaWJlKFxuICAgICAgICBtZXNzYWdlID0+IHtcbiAgICAgICAgICBjbGllbnQuc2VuZChtZXNzYWdlKTtcbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9LFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgY2xpZW50LmZpbmlzaFNlbmQoKTtcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIGNsaWVudC5vbk1lc3NhZ2UoZGF0YSA9PiBvYnMubmV4dChuZXcgR3JwY0RhdGFFdmVudChkYXRhIGFzIGFueSkpKTtcblxuICAgICAgY2xpZW50Lm9uRW5kKChzdGF0dXMsIHN0YXR1c01lc3NhZ2UsIHRyYWlsZXJzKSA9PiB7XG4gICAgICAgIG9icy5uZXh0KG5ldyBHcnBjU3RhdHVzRXZlbnQoc3RhdHVzLCBzdGF0dXNNZXNzYWdlLCB0aGlzLmNhc3RSZXNwb25zZU1ldGFkYXRhKHRyYWlsZXJzKSkpO1xuICAgICAgICBvYnMuY29tcGxldGUoKTtcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICBpbnB1dFN0cmVhbVN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICBjbGllbnQuY2xvc2UoKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBiaWRpU3RyZWFtPFEgZXh0ZW5kcyBHcnBjTWVzc2FnZSwgUyBleHRlbmRzIEdycGNNZXNzYWdlPihcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgaW5wdXRTdHJlYW06IE9ic2VydmFibGU8UT4sXG4gICAgbWV0YWRhdGE6IEdycGNNZXRhZGF0YSxcbiAgICByZXFjbHNzOiBHcnBjTWVzc2FnZUNsYXNzPFE+LFxuICAgIHJlc2Nsc3M6IEdycGNNZXNzYWdlQ2xhc3M8Uz4sXG4gICk6IE9ic2VydmFibGU8R3JwY0V2ZW50PFM+PiB7XG4gICAgY29uc3QgbWV0aG9kTmFtZSA9IHBhdGguc3BsaXQoJy8nKVsyXTtcblxuICAgIGNvbnN0IG1ldGhvZERlc2NyaXB0b3IgPSB7XG4gICAgICBtZXRob2ROYW1lLFxuICAgICAgc2VydmljZTogdGhpcy5jbGllbnQsXG4gICAgICByZXF1ZXN0U3RyZWFtOiB0cnVlLFxuICAgICAgcmVzcG9uc2VTdHJlYW06IGZhbHNlLFxuICAgICAgcmVxdWVzdFR5cGU6IHJlcWNsc3MsXG4gICAgICByZXNwb25zZVR5cGU6IHJlc2Nsc3MsXG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnMgPT4ge1xuICAgICAgY29uc3QgY2xpZW50ID0gZ3JwYy5jbGllbnQobWV0aG9kRGVzY3JpcHRvciwge1xuICAgICAgICBob3N0OiB0aGlzLnNldHRpbmdzLmhvc3QsXG4gICAgICAgIHRyYW5zcG9ydDogdGhpcy5nZXRUcmFuc3BvcnQoJ2JpZGlTdHJlYW0nKSxcbiAgICAgICAgZGVidWc6IHRoaXMuc2V0dGluZ3MuZGVidWcsXG4gICAgICB9KTtcblxuICAgICAgY2xpZW50LnN0YXJ0KG5ldyBncnBjLk1ldGFkYXRhKG1ldGFkYXRhPy50b09iamVjdCgpID8/IHt9KSk7XG5cbiAgICAgIGNvbnN0IGlucHV0U3RyZWFtU3ViID0gaW5wdXRTdHJlYW0uc3Vic2NyaWJlKFxuICAgICAgICBtZXNzYWdlID0+IHtcbiAgICAgICAgICBjbGllbnQuc2VuZChtZXNzYWdlKTtcbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9LFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgY2xpZW50LmZpbmlzaFNlbmQoKTtcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIGNsaWVudC5vbk1lc3NhZ2UoZGF0YSA9PiBvYnMubmV4dChuZXcgR3JwY0RhdGFFdmVudChkYXRhIGFzIGFueSkpKTtcblxuICAgICAgY2xpZW50Lm9uRW5kKChzdGF0dXMsIHN0YXR1c01lc3NhZ2UsIHRyYWlsZXJzKSA9PiB7XG4gICAgICAgIG9icy5uZXh0KG5ldyBHcnBjU3RhdHVzRXZlbnQoc3RhdHVzLCBzdGF0dXNNZXNzYWdlLCB0aGlzLmNhc3RSZXNwb25zZU1ldGFkYXRhKHRyYWlsZXJzKSkpO1xuICAgICAgICBvYnMuY29tcGxldGUoKTtcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICBpbnB1dFN0cmVhbVN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICBjbGllbnQuY2xvc2UoKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNhc3RSZXNwb25zZU1ldGFkYXRhKHsgaGVhZGVyc01hcCB9OiBNZXRhZGF0YSkge1xuICAgIHJldHVybiBuZXcgR3JwY01ldGFkYXRhKE9iamVjdC5rZXlzKGhlYWRlcnNNYXApLnJlZHVjZSgociwgaykgPT4gKHsgLi4uciwgW2tdOiBoZWFkZXJzTWFwW2tdWzBdIH0pLCB7fSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUcmFuc3BvcnQoa2V5OiBrZXlvZiBJbXByb2JhYmxlRW5nR3JwY1dlYkNsaWVudFRyYW5zcG9ydHMpIHtcbiAgICBjb25zdCB7IHRyYW5zcG9ydCB9ID0gdGhpcy5zZXR0aW5ncztcblxuICAgIHJldHVybiB0eXBlb2YgdHJhbnNwb3J0ID09PSAnZnVuY3Rpb24nID8gdHJhbnNwb3J0IDogdHJhbnNwb3J0W2tleV07XG4gIH1cblxufVxuIl19